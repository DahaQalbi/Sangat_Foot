<div class="panel">
  <div class="mb-5 flex items-center justify-between gap-3">
    <h5 class="text-lg font-extrabold text-red-600">Add Order</h5>
    <form [formGroup]="form" class="flex items-center gap-2">

      <input type="text" class="form-input hidden" formControlName="notes" placeholder="Notes" />
    </form>
  </div>
  <!-- Two-column layout: Left = Add Order, Right = Table Info -->
  <div class="grid items-start gap-6 md:grid-cols-2 md:gap-8">
    <div class="md:col-span-1">
      
  <!-- Search bar + Reset -->
  <div class="mb-3 flex items-center gap-2">
    <div class="relative w-full">
      <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.8"/></svg>
      </span>
      <input [(ngModel)]="search" [ngModelOptions]="{standalone:true}" type="text" class="form-input w-full pl-9" placeholder="Search your menu item here" />
    </div>
    <button type="button" class="btn btn-primary" (click)="search=''; selectedCategory='All'">Reset</button>
  </div>

  <!-- Category chips -->
  <div class="mb-4 flex flex-wrap items-center gap-2">
    <button type="button" *ngFor="let c of categories"
            (click)="selectedCategory=c"
            class="px-3 py-1.5 rounded-full border transition-colors text-sm"
            [ngClass]="selectedCategory===c ? 'bg-red-600 text-white border-red-600 shadow' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'">
      <span>{{ c }}</span>
    </button>
    <button type="button" *ngIf="deals?.length"
            (click)="selectedCategory='Deals'"
            class="px-3 py-1.5 rounded-full border transition-colors text-sm"
            [ngClass]="selectedCategory==='Deals' ? 'bg-red-600 text-white border-red-600 shadow' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'">
      <span>Deals</span>
    </button>
  </div>

  <div *ngIf="loading" class="rounded border border-gray-200 p-4 dark:border-gray-700">Loading products...</div>
  <div *ngIf="error" class="rounded border border-red-200 bg-red-50 p-4 text-red-700 dark:border-red-700 dark:bg-transparent">{{ error }}</div>

  <!-- Product grid -->
  <div *ngIf="!loading && !error && selectedCategory!=='Deals'">
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      <div *ngFor="let p of filteredProducts; trackBy: trackByProductId" class="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm transition hover:shadow-md dark:border-gray-700 dark:bg-[#0e1726]">
        <div class="relative w-full overflow-hidden bg-gray-100 h-20 sm:h-24 lg:h-28" (click)="toggleSelect(p)">
          <img [src]="p.image"
               alt="{{p.name}}"
               class="h-full w-full object-cover"
               loading="lazy"
               decoding="async"
               fetchpriority="low"
               (error)="onImgError($event)" />
          <button type="button" (click)="$event.stopPropagation(); toggleSelect(p)"
                  class="absolute right-2 top-2 grid h-8 w-8 place-items-center rounded-full border text-white shadow"
                  [ngClass]="isSelected(p) ? 'bg-red-600 border-red-600' : 'bg-gray-700/70 border-white/30'">
            <svg *ngIf="isSelected(p)" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
            <svg *ngIf="!isSelected(p)" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
          </button>
          
        </div>
        <div class="p-1">
          <div class="truncate font-semibold text-sm text-gray-800 dark:text-gray-100">{{ p.name }}</div>
          <div class="mt-0.5 text-primary font-bold text-sm">${{ priceOf(p) | number:'1.0-2' }}</div>
          <div class="mt-2" *ngIf="isSelected(p)">
            <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 13l4 4L19 7" /></svg>
              Selected
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Deals section -->
  <div class="mb-5" *ngIf="selectedCategory==='Deals' && deals && deals.length">
    <div class="mb-2 font-extrabold text-gray-800 dark:text-gray-100">Deals</div>
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      <div *ngFor="let d of deals" class="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm transition hover:shadow-md dark:border-gray-700 dark:bg-[#0e1726]">
        <div class="relative w-full overflow-hidden bg-gray-100 h-28 sm:h-36 lg:h-44">
          <img [src]="(d.items?.[0]?.image ? d.items[0].image : '/assets/images/placeholder.png')"
               alt="Deal"
               class="h-full w-full object-cover" />
        </div>
        <div class="p-3">
          <div class="truncate font-semibold text-gray-800 dark:text-gray-100">{{ d.name || 'Deal' }}</div>
          <div class="mt-2 flex items-center justify-between">
            <span class="text-sm text-gray-500">{{ (d.items||d.dealItem||[]).length }} items</span>
            <button type="button" class="btn btn-primary btn-sm" (click)="addDealToSelection(d)">Add Deal</button>
          </div>
        </div>
      </div>
    </div>
  </div>
    </div>
    <div class="md:col-span-1 md:border-l md:pl-4 border-gray-200 dark:border-white/10">
      <div class="sticky top-4 max-h-[calc(100vh-5rem)] overflow-auto">
        <app-table-info class="block w-full" [orderIdOverride]="embeddedOrderId"
                        [summaryOverride]="selectedSummaryCache"
                        [dealIdOverride]="null"
                        (quantityChanged)="onChildQtyChanged($event)"></app-table-info>
      </div>
    </div>
  </div>

  <!-- Size Selection Modal -->
  <div *ngIf="sizeModalOpen" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 p-4">
    <div class="w-full max-w-lg rounded-lg bg-white p-4 shadow-xl dark:bg-[#0e1726]">
      <div class="mb-3 flex items-center justify-between">
        <div class="font-extrabold text-gray-800 dark:text-gray-100">Select Size</div>
        <button type="button" class="text-gray-500 hover:text-gray-800" (click)="closeSizeModal()">âœ•</button>
      </div>
      <div class="mb-3 text-sm text-gray-500">{{ activeProduct?.name }}</div>

      <div class="mb-2 flex flex-wrap gap-2">
        <button *ngFor="let s of sizeChips" type="button"
                class="rounded-full border border-gray-200 bg-red-50 px-3 py-1 font-semibold text-red-700 hover:bg-red-100 dark:border-gray-700 dark:bg-red-900/20 dark:text-red-300"
                (click)="selectChipForRow(s)">
          {{ s.type || 'Default' }} - ${{ s.sale | number:'1.0-2' }}
        </button>
      </div>

      <!-- Manual entry rows (click a row to target chip fill) -->
      <div [formGroup]="sizeForm" class="space-y-2">
        <div formArrayName="sizes" class="space-y-3">
          <div *ngFor="let ctrl of sizesFA.controls; let i = index" (click)="chipTargetIndex=i" class="rounded-md border p-3 hover:border-primary cursor-pointer" [class.border-primary]="chipTargetIndex===i">
            <app-size-type-row [group]="$any(ctrl)" [index]="i" (remove)="removeSizeRow(i)"></app-size-type-row>
          </div>
        </div>
        <!-- Single default row only; Add More hidden as requested -->
      </div>

      <div class="mt-4 flex items-center justify-end gap-2">
        <button type="button" class="btn btn-outline-primary" (click)="closeSizeModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="confirmAddFromModal()">Add to Cart</button>
      </div>
    </div>
  </div>
</div>
